---
// src/pages/view/[id].astro - Direct HTML rendering page
// This page directly renders user HTML content without iframe

import { DatabaseService, getDatabase } from '../../lib/database';
import { getCacheService } from '../../lib/cache';
import { SecurityService } from '../../lib/security';
import { HTMLProcessor } from '../../lib/htmlProcessor';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/');
}

// Get database and cache from Cloudflare environment
const db = getDatabase(Astro.locals);
const cache = getCacheService(Astro.locals);

if (!db) {
  return new Response('Database not available', { status: 500 });
}

// Fetch page content with cache support
let pageData = null;
try {
  const dbService = new DatabaseService(db, cache);
  pageData = await dbService.getPageByUrlId(id as string);

  if (pageData) {
    // Increment view count
    await dbService.incrementViewCount(id as string);
  }
} catch (error) {
  console.error('Database error:', error);
}

if (!pageData) {
  // Return 404 page
  return new Response(`
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>é¡µé¢æœªæ‰¾åˆ° - HTMLShare</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            }
            .container {
                text-align: center;
                background: white;
                padding: 3rem 2rem;
                border-radius: 1rem;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                max-width: 500px;
                width: 90%;
            }
            h1 { color: #333; margin-bottom: 1rem; }
            p { color: #666; margin-bottom: 2rem; line-height: 1.6; }
            .btn {
                display: inline-block;
                padding: 12px 24px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-decoration: none;
                border-radius: 8px;
                font-weight: 500;
                transition: transform 0.2s;
            }
            .btn:hover { transform: translateY(-2px); }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ” é¡µé¢æœªæ‰¾åˆ°</h1>
            <p>æŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„HTMLé¡µé¢ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ã€‚</p>
            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </div>
    </body>
    </html>
  `, {
    status: 404,
    headers: { 'Content-Type': 'text/html; charset=utf-8' }
  });
}

// Set appropriate headers for direct HTML rendering with enhanced security
const headers = new Headers();
headers.set('Content-Type', 'text/html; charset=utf-8');
headers.set('Cache-Control', 'public, max-age=3600'); // Cache for 1 hour

// Enhanced security headers
const securityHeaders = SecurityService.getSecurityHeaders();
Object.entries(securityHeaders).forEach(([key, value]) => {
  headers.set(key, value);
});

// Optimized CSP for user-generated content
headers.set('Content-Security-Policy', SecurityService.getCSPHeader());

// Allow cross-origin requests for external resources
headers.set('Cross-Origin-Embedder-Policy', 'unsafe-none');
headers.set('Cross-Origin-Opener-Policy', 'unsafe-none');

// Process HTML content with enhanced processor for better rendering
let processedContent = HTMLProcessor.processHTML(pageData.content);

// Apply additional sanitization for security
processedContent = HTMLProcessor.sanitizeForDisplay(processedContent);

// Extract title from HTML content for better social sharing
const titleMatch = processedContent.match(/<title[^>]*>([^<]*)<\/title>/i);
const extractedTitle = titleMatch ? titleMatch[1].trim() : pageData.title || 'Shared HTML';

// Generate social media meta tags
const shareUrl = `https://htmlshare.top/view/${id}`;
const shareTitle = `${extractedTitle} - HTMLShare`;
const shareDescription = pageData.description || `æŸ¥çœ‹åœ¨ HTMLShare ä¸Šåˆ†äº«çš„ HTML ä»£ç : ${extractedTitle}`;
const shareImage = 'https://htmlshare.top/og-image.png';

// Inject social media meta tags into the HTML head
const socialMetaTags = `
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article" />
  <meta property="og:url" content="${shareUrl}" />
  <meta property="og:title" content="${shareTitle}" />
  <meta property="og:description" content="${shareDescription}" />
  <meta property="og:image" content="${shareImage}" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:image:alt" content="HTMLShare - æç®€ä»£ç åˆ†äº«å·¥å…·" />
  <meta property="og:site_name" content="HTMLShare" />
  <meta property="og:locale" content="zh_CN" />

  <!-- Twitter Cards -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="@htmlshare" />
  <meta name="twitter:creator" content="@spsz831" />
  <meta name="twitter:title" content="${shareTitle}" />
  <meta name="twitter:description" content="${shareDescription}" />
  <meta name="twitter:image" content="${shareImage}" />
  <meta name="twitter:image:alt" content="HTMLShare - æç®€ä»£ç åˆ†äº«å·¥å…·" />

  <!-- Additional SEO Meta Tags -->
  <meta name="description" content="${shareDescription}" />
  <meta name="robots" content="index, follow" />
  <meta name="author" content="HTMLShare" />
  <link rel="canonical" href="${shareUrl}" />
`;

// Inject meta tags into HTML head
if (processedContent.includes('<head>')) {
  processedContent = processedContent.replace(
    /<head([^>]*)>/i,
    `<head$1>${socialMetaTags}`
  );
} else if (processedContent.includes('<html')) {
  // If no head tag, add one after html tag
  processedContent = processedContent.replace(
    /<html([^>]*)>/i,
    `<html$1><head>${socialMetaTags}</head>`
  );
} else {
  // If no html structure, wrap with basic HTML
  processedContent = `<!DOCTYPE html><html><head>${socialMetaTags}</head><body>${processedContent}</body></html>`;
}

// Directly return the processed HTML content with social meta tags
return new Response(processedContent, {
  status: 200,
  headers: headers
});
---