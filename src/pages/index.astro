---
// src/pages/index.astro - Main upload page (Simplified Design)
import Layout from '../layouts/Layout.astro';
---

<Layout title="HTMLShare - Simple HTML Sharing">
  <main class="min-h-screen bg-white">
    <!-- Simplified Header -->
    <header class="border-b border-gray-100 py-6">
      <div class="max-w-3xl mx-auto px-4">
        <h1 class="text-3xl font-bold text-gray-900 text-center">
          HTMLShare
        </h1>
        <p class="text-gray-500 text-center mt-2 text-sm">
          Paste HTML code or upload files to generate shareable links
        </p>
      </div>
    </header>

    <!-- Simplified Main Content -->
    <div class="max-w-3xl mx-auto px-4 py-12">

      <!-- Simplified Upload Form -->
      <div class="bg-gray-50 rounded-lg border border-gray-200 p-6">
        <form id="htmlForm">
          <!-- HTML Content -->
          <div class="mb-4">
            <label for="content" class="block text-sm font-medium text-gray-700 mb-2">
              HTML Content
            </label>
            <textarea
              id="content"
              name="content"
              placeholder="Paste your HTML code here..."
              rows="16"
              class="w-full p-4 font-mono text-sm bg-white border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            ></textarea>
          </div>

          <!-- Simplified Actions -->
          <div class="flex gap-3 justify-between">
            <div class="flex gap-3">
              <label class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 cursor-pointer text-sm">
                üìÅ Upload File
                <input
                  type="file"
                  id="fileInput"
                  accept=".html,.htm"
                  class="hidden"
                />
              </label>

              <button
                type="button"
                id="clearBtn"
                class="px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm"
              >
                üóëÔ∏è Clear
              </button>
            </div>

            <button
              type="submit"
              id="submitBtn"
              class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm disabled:opacity-50"
            >
              Generate Link
            </button>
          </div>
        </form>
      </div>

      <!-- Simplified Result Section -->
      <div id="result" class="mt-6 hidden">
        <!-- Result content will be inserted here -->
      </div>

      <!-- Simplified Error Section -->
      <div id="error" class="mt-6 hidden">
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-red-800 font-medium">‚ùå Creation failed</p>
          <p id="errorMessage" class="text-red-600 text-sm mt-1"></p>
        </div>
      </div>
    </div>
  </main>

  <!-- Simplified JavaScript -->
  <script>
    const form = document.getElementById('htmlForm');
    const fileInput = document.getElementById('fileInput');
    const clearBtn = document.getElementById('clearBtn');
    const contentTextarea = document.getElementById('content');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const submitBtn = document.getElementById('submitBtn');

    // File upload
    fileInput?.addEventListener('change', function(e) {
      const file = e.target.files?.[0];
      if (file && file.type === 'text/html') {
        const reader = new FileReader();
        reader.onload = function(e) {
          contentTextarea.value = e.target?.result || '';
        };
        reader.readAsText(file);
      }
    });

    // Clear form
    clearBtn?.addEventListener('click', function() {
      form?.reset();
      resultDiv?.classList.add('hidden');
      errorDiv?.classList.add('hidden');
    });

    // Form submission
    form?.addEventListener('submit', async function(e) {
      e.preventDefault();

      const submitButton = submitBtn;
      const originalText = submitButton?.textContent;

      try {
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = '‚è≥ Creating...';
        }

        const formData = new FormData(form);
        const response = await fetch('/api/pages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: 'Shared HTML',
            content: formData.get('content'),
            language: 'html',
            description: null,
            is_public: true
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        if (data.success) {
          showResult(data.data);
        } else {
          throw new Error(data.error || 'Creation failed');
        }

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      }
    });

    function showResult(pageData) {
      const baseUrl = window.location.origin;
      const shareUrl = `${baseUrl}/view/${pageData.url_id}`;

      resultDiv.innerHTML = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-green-800 font-medium mb-3">‚úÖ Share link created:</p>
          <div class="flex gap-2">
            <input
              type="text"
              value="${shareUrl}"
              readonly
              class="flex-1 px-3 py-2 bg-white border border-green-300 rounded text-sm font-mono focus:outline-none"
            />
            <button
              onclick="copyToClipboard('${shareUrl}')"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
            >
              üìã Copy
            </button>
            <a
              href="${shareUrl}"
              target="_blank"
              rel="noopener noreferrer"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
            >
              üîó Open
            </a>
          </div>
        </div>
      `;
      resultDiv?.classList.remove('hidden');
      errorDiv?.classList.add('hidden');
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      errorDiv?.classList.remove('hidden');
      resultDiv?.classList.add('hidden');
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        console.log('Copied to clipboard');
      });
    }
  </script>
</Layout>